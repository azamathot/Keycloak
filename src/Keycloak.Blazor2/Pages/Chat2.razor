@page "/chat2/{taskId}"
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpClientFactory Factory

@using Keycloak.Blazor.Data
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.AspNetCore.SignalR.Client;
@using System.IdentityModel.Tokens.Jwt

@attribute [Authorize]

<h3>Чат</h3>
<div class="chat-container">
    <ul id="messages" class="chat-messages">
        @foreach (var message in messages)
        {
            <li class="message @(message.UserId == userId ? "user-message" : "admin-message")">
                <span class="sender">@message.Sender</span>:
                <span class="content">@message.Message</span>
            </li>
        }
    </ul>
    <input type="text" @bind-value="newMessage" placeholder="Введите сообщение" />
    <button @onclick="SendMessage">Отправить</button>
</div>

@code {
    private int taskId;
    private string userId;
    private List<ChatMessage> messages = new List<ChatMessage>();
    private string newMessage;

    private HubConnection hubConnection;
    private HttpClient Http;

    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        taskId = int.Parse(query["taskId"]);

        await GetUserId();

        hubConnection = new HubConnectionBuilder()
            .WithUrl("http://localhost:5000/chat", options =>
            {
                options.AccessTokenProvider = () => GetAccessToken();
            })
            .Build();

        await hubConnection.StartAsync();
        await hubConnection.InvokeAsync("SendMessage", taskId, "Привет!");

        hubConnection.On<string, string>("ReceiveMessage", (userId, message) =>
        {
            messages.Add(new ChatMessage { UserId = userId, Message = message });
            StateHasChanged();
        });

        Http = Factory.CreateClient("API");
        await LoadMessages(taskId);
    }

    private async Task GetUserId()
    {
        var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authenticationState.User;
        userId = user.FindFirst(JwtRegisteredClaimNames.Sub).Value;
    }

    private async Task<string> GetAccessToken()
    {
        var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authenticationState.User;
        var tmp = user.FindFirst(c => c.Type == "access_token")?.Value;
        var token = tmp;
        return token;
    }

    private async Task LoadMessages(int taskId)
    {
        var response = await Http.GetFromJsonAsync<List<ChatMessage>>($"api/chat?taskId={taskId}");
        messages = response;
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrEmpty(newMessage))
        {
            await hubConnection.InvokeAsync("SendMessage", taskId, newMessage);
            newMessage = string.Empty;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // var messagesElement = document.getElementById("messages");
            // messagesElement.scrollTop = messagesElement.scrollHeight;
        }
    }
}
